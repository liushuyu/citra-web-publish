<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
        <meta name="theme-color" content="#FF8E03">
        <meta property="og:title" content="Hardware Renderer Updates &middot; Citra" />
        <meta property="og:site_name" content="Citra" />
        <meta property="og:url" content="https://citra-emu.org/entry/improvements-to-hardware-renderer/" />
            <meta property="og:description" content="Cut to the chase, how fast is this?








    
    
    
        
        
        
        
            
                
                    
                        
                            
                            Your browser doesn&#39;t support mp4 video. :(
                        
                    
                
                
                    
                        Before
                    
                
            
        
    
        
        
        
        
            
                
                    
                        
                            
                            Your browser doesn&#39;t support mp4 video. :(
                        
                    
                
                
                    
                        After
                    
                
            
        
    
    



Realtime performance comparison with framelimit off" />
<meta name="description" content="Cut to the chase, how fast is this?








    
    
    
        
        
        
        
            
                
                    
                        
                            
                            Your browser doesn&#39;t support mp4 video. :(
                        
                    
                
                
                    
                        Before
                    
                
            
        
    
        
        
        
        
            
                
                    
                        
                            
                            Your browser doesn&#39;t support mp4 video. :(
                        
                    
                
                
                    
                        After
                    
                
            
        
    
    



Realtime performance comparison with framelimit off" />
<meta property="og:type" content="article" />
<meta property="og:image" content="https://citra-emu.org/images/banners/hardware-shaders.png" />
<meta property="og:article:published_time" content="2018-03-10T17:00:00-04:00" />
<meta property="og:article:tag" content="feature-update" />


        <meta name="generator" content="Hugo 0.52" />

        <link rel="icon" href="https://citra-emu.org/favicon.ico" />
        <link rel="shortcut icon" href="https://citra-emu.org/favicon.ico" type="image/x-icon" />
        <link rel="canonical" href="https://citra-emu.org/entry/improvements-to-hardware-renderer/">

        

        <title>Hardware Renderer Updates - Citra</title>
        <link href="https://fonts.googleapis.com/css?family=Ubuntu|Dosis" rel="stylesheet">
        <link rel="stylesheet" href="https://citra-emu.org/css/style.css"/>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"
                integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>

        
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-73966905-1', 'auto');
                ga('send', 'pageview');
            </script>
        
    </head>

    <body>
        <nav class="navbar navbar-default navbar-wrapper navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">&nbsp;</a>
        </div>

        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="index-1 first"><a href="/" title="Blog Posts">Blog</a></li>
                <li class="index-2"><a href="/download/" title="Download Citra">Download</a></li>
                <li class="index-3"><a href="/help/" title="Help">Help</a></li>
                <li class="index-4"><a href="/wiki/faq/" title="Frequently Asked Questions">FAQ</a></li>
                <li class="index-5"><a href="/game/" title="Game Compatibility">Compatibility</a></li>
                <li class="index-6"><a href="/wiki/home/" title="Wiki Homepage">Dev Wiki</a></li>

                <li class="index-7 dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                       role="button" aria-haspopup="true" aria-expanded="false">
                        Social <span class="caret"></span>
                    </a>

                    <ul class="dropdown-menu">
                        <li class="index-1 first"><a href="/rules/" title="">Rules</a></li>
                        <li class="index-2"><a href="https://community.citra-emu.org/" title="Forums">Community Forums</a></li>
                        <li class="index-3 last"><a href="/discord/" title="Discord Channel">Discord Chat</a></li>
                    </ul>
                </li>

                <li class="index-8 dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                                                aria-haspopup="true" aria-expanded="false">
                        Media <span class="caret"></span>
                    </a>

                    <ul class="dropdown-menu">
                        <li class="index-1 first"><a href="/screenshots/" title="Screenshots">Screenshots</a></li>
                        <li class="index-2 last"><a href="https://www.youtube.com/channel/UC_dcdgzuapBtAY4ol3x-90Q"
                                                    title="Youtube Channel">Videos</a></li>
                    </ul>
                </li>

                <li class="index-9 last"><a href="https://www.patreon.com/citraemu" title="Patreon">Patreon</a></li>
            </ul>
        </div>
    </div>
</nav>


        <div id="mainContainer" class="container" >
            <div class="row">
                
            </div>

            <div class="row row-fluid">
                <div id="content" class="col-xs-12 col-sm-12 col-md-9 col-lg-9 pull-right">
                    
  <a href="https://citra-emu.org/entry/improvements-to-hardware-renderer/">
  <div class="entry-embed-header">
      <div class="entry-embed" style="background: url('https://citra-emu.org/images/banners/hardware-shaders.png')">
          <header>
              <h1>Hardware Renderer Updates</h1>
          </header>
      </div>

      
      <div class="entry-meta" style="position: absolute; top: 5px; right: 20px;">
          March 10 2018
      </div>

      
      <div class="entry-meta" style="position: absolute; top: 45px; right: 20px;">
          feature-update
      </div>
      
  </div>
</a>


  <div class="entry-content">
    <h2 id="cut-to-the-chase-how-fast-is-this">Cut to the chase, how fast is this?</h2>







<div class="container" style="width: 100%;">
    
    <div class="is-img-preview">
    
        
        
        
        <div class="theme-table-image col-sm-6">
            <figure style="padding: 0px;">
                
                    <div class="embed-responsive embed-responsive-4by3">
                        <video class="embed-responsive-item" preload="auto" autoplay="autoplay" muted="muted" loop="loop" webkit-playsinline="">
                            <source src="/images/entry/improvements-to-hardware-renderer/before.mp4" type="video/mp4">
                            Your browser doesn't support mp4 video. :(
                        </video>
                    </div>
                
                <figcaption>
                    <h4>
                        Before
                    </h4>
                </figcaption>
            </figure>
        </div>
    
        
        
        
        <div class="theme-table-image col-sm-6">
            <figure style="padding: 0px;">
                
                    <div class="embed-responsive embed-responsive-4by3">
                        <video class="embed-responsive-item" preload="auto" autoplay="autoplay" muted="muted" loop="loop" webkit-playsinline="">
                            <source src="/images/entry/improvements-to-hardware-renderer/after.mp4" type="video/mp4">
                            Your browser doesn't support mp4 video. :(
                        </video>
                    </div>
                
                <figcaption>
                    <h4>
                        After
                    </h4>
                </figcaption>
            </figure>
        </div>
    
    </div>
</div>


<h4 style="text-align: center;">Realtime performance comparison with framelimit off</h4>

<p>Very fast. Test results across various computers show that it <strong>averages out to be a 2x speed boost.</strong>
With the new update, Citra will use much more of your GPU, removing some of the dependence on a CPU with high single-core performance.
As always, the actual difference will vary by game and by your specific hardware configuration!
In celebration of this massive improvement, we wanted to share some of the successes and struggles we&rsquo;ve had over the years with the hardware renderer.</p>

<h2 id="brief-history-of-citra-s-rendering-backends">Brief History of Citra&rsquo;s Rendering Backends</h2>

<p>Back in early 2015, Citra was still a young emulator, and had just barely started displaying graphics for the first time.
In a momentous occasion, Citra displayed 3D graphics from a commercial game, Legend of Zelda: Ocarina of Time 3D</p>



<figure >
    
        
        <div style="position: relative; padding-bottom: 56.25%; padding-top: 30px; height: 0; overflow: hidden;">
            <iframe src="//www.youtube.com/embed/sYukdJam6gk?"
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" allowfullscreen frameborder="0" title="YouTube Video"></iframe>
        </div>
    
    
    <figcaption>
        <h4>
            It took a year from when citra started to get to this point
        </h4>
    </figcaption>
    
</figure>


<p>This engineering feat was thanks to the hard work of many contributors in both the emulator scene and the 3ds hacking scene, who worked tirelessly to reverse engineer the 3DS GPU, a chip called the PICA200.
But not even a few months later, Citra was able to play the game at full speed!</p>



<figure >
    
        
        <div style="position: relative; padding-bottom: 56.25%; padding-top: 30px; height: 0; overflow: hidden;">
            <iframe src="//www.youtube.com/embed/Hj8sPsB5qXQ?"
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" allowfullscreen frameborder="0" title="YouTube Video"></iframe>
        </div>
    
    
    <figcaption>
        <h4>
            Good thing that shield flashing bug still isn&rsquo;t around
        </h4>
    </figcaption>
    
</figure>


<p>Why is there such a major difference in speed from the first and the second video?
The speed difference boils down to how the 3DS GPU is being emulated.
The first video is showing off the software renderer, which emulates the PICA200 by using your computer&rsquo;s CPU.
On the other hand, the second video is using the OpenGL hardware renderer, which emulates the PICA200 by using your computer&rsquo;s GPU.
From those videos, using your GPU to emulate the 3DS GPU is the clear winner when it comes to speed!
However, it&rsquo;s not all sunshine and daisies; there&rsquo;s always tradeoffs in software development.</p>

<h2 id="challenges-in-the-hardware-renderer">Challenges in the Hardware Renderer</h2>

<p>Earlier it was stated that the OpenGL hardware renderer was emulating the PICA200 by using the GPU instead of the CPU, and &hellip; that&rsquo;s only partially true.
As it stands, only a portion of the PICA200 emulation is running on the GPU; most of it is running on the CPU!
To understand why, we need to dive a little deeper into the difference between CPUs and modern GPUs.</p>



<figure >
    
        <img src="/images/entry/improvements-to-hardware-renderer/gpu_pipeline_before.png"  />
    
    
    <figcaption>
        <h4>
            The green shaded portions are what Citra emulates using the GPU. For a hardware renderer, Citra isn&rsquo;t using the GPU much!
        </h4>
    </figcaption>
    
</figure>


<p>As a general rule of thumb, CPUs are fast at computing general tasks, while GPUs are <em>blazing fast</em> at computing very specific tasks.
Whenever the tasks the PICA200 can perform matches up with tasks you can do on a GPU using OpenGL, everything is fast and everyone is happy!
That said, we tend to run into edge cases that the PICA200 supports, but frankly, OpenGL is not well suited to support.
This leads to cases where sometimes we just have to <a href="https://github.com/citra-emu/citra/pull/2697">live with minor inaccuracies as a tradeoff for speed.</a></p>



<figure >
    
        <img src="/images/entry/improvements-to-hardware-renderer/outline_bug.png"  />
    
    
    <figcaption>
        <h4>
            The infamous Pokémon outlines bug was one such example of something that OpenGL just doesn&rsquo;t handle well
        </h4>
    </figcaption>
    
</figure>


<p>OpenGL is also great for emulator developers because it&rsquo;s a cross-platform standard for graphics, with support for all major desktop platforms.
But because OpenGL is just a specification, every vendor is left up to their own to make their drivers support the specification for every individual platform.
This means performance and features can vary widely between operating systems, graphics driver, and the physical graphics card.
As you might have guessed, this leads to some <a href="https://github.com/citra-emu/citra/issues/2416">OS specific bugs that are very hard to track down</a>.
In the linked issue, only on Mac OSX, Citra would leak memory from the hardware renderer.
We traced it back to how textures were juggled between the 3DS memory and the host GPU, but we don&rsquo;t have many developers that use Mac, so we never did find the root cause.
For a little bit of good news, <strong>this is fixed in the latest nightly</strong>, but only because the entire texture handling code was rewritten!</p>

<h2 id="moving-forward-with-the-hardware-renderer-cleaning-up-texture-forwarding">Moving Forward with the Hardware Renderer: Cleaning up Texture Forwarding</h2>

<p>Despite the issues mentioned above, OpenGL has been a fair choice for a hardware renderer, and <a href="https://github.com/phanto-m/">phantom</a> has been hard at work improving the renderer.
Their first major contribution was a massive, <a href="https://github.com/citra-emu/citra/pull/3281">complete rewrite</a> of the <a href="https://citra-emu.org/entry/texture-forwarding-brings-hd-output-to-citra/">texture forwarding support</a> that was added back in 2016.
The new texture forwarding code increases the speed of many games, and fixes upscaled rendering in some other games as well.</p>

<p>

<figure >
    
        <img src="/images/entry/improvements-to-hardware-renderer/metroid_before.png"  />
    
    
    <figcaption>
        <h4>
            Metroid: Samus Returns heavily used a PICA200 feature that had a comment <code>// TODO: implement this</code> in the hardware renderer
        </h4>
    </figcaption>
    
</figure>



<figure >
    
        <img src="/images/entry/improvements-to-hardware-renderer/metroid_after.png"  />
    
    
    <figcaption>
        <h4>
            Writing that missing method fixed upscaling while making the game much faster
        </h4>
    </figcaption>
    
</figure>
</p>

<p>Whenever a texture is used in the hardware renderer, the hardware renderer will try to use a copy of the texture already in the GPU memory, but if that fails, it has to reload the texture from the emulated 3DS memory.
This is called a texture upload, and it&rsquo;s slow for a good reason.
The communication between CPU and GPU is optimized for large amounts of data transferred, but as a tradeoff, it&rsquo;s not very fast.
This works great for PC games, where you know all the textures you want to upload ahead of time and can send them in one large batch, but ends up hurting performance for Citra since we can&rsquo;t know in advance when the emulated game will do something that requires a texture upload.</p>

<p>The texture forwarding rewrite increases the speed of many games by adding in new checks to avoid this costly synchronization of textures between emulated 3DS memory and the host GPU memory.
Additionally, the new texture forwarding can avoid even more texture uploads by copying the data from any compatible locations.
As an extension of this feature, <a href="https://github.com/phanto-m/">phantom</a> went the extra mile and fixed Pokémon outlines as well!
Pokémon games would draw the outline by reinterpreting the depth and stencil buffer as an RGBA texture, using the value for the red color to draw the outline.
Sadly, OpenGL doesn&rsquo;t let you just reinterpret like that, meaning we needed to be more creative.
<a href="https://github.com/phanto-m/">phantom</a> worked around this limitation by copying the data into a <a href="https://www.khronos.org/opengl/wiki/Pixel_Buffer_Object">Pixel Buffer Object</a>, and running a shader to extract the data into a <a href="https://www.khronos.org/opengl/wiki/Buffer_Texture">Buffer Texture</a> which they could use to draw into a new texture with the correct format.</p>



<figure >
    
        <img src="/images/entry/improvements-to-hardware-renderer/outline_upscaled.png"  />
    
    
    <figcaption>
        <h4>
            The long standing issue is gone!
        </h4>
    </figcaption>
    
</figure>


<p>The texture forwarding rewrite has been battle tested in Citra Canary for the last 2 months, during which time we fixed over 20 reported issues.
We are happy to announce that it&rsquo;s now merged into the master branch, so please enjoy the new feature in the latest nightly build!</p>

<h2 id="the-big-news-you-ve-been-waiting-for">The Big News You&rsquo;ve Been Waiting For</h2>

<p>A few paragraphs ago, we mentioned that Citra&rsquo;s hardware renderer did most of the emulation on the CPU, and only some of it on the GPU.
The big news today is Citra now does the <strong>entire GPU emulation on the host GPU</strong>.</p>



<figure >
    
        <img src="/images/entry/improvements-to-hardware-renderer/gpu_pipeline_after.png"  />
    
    
    <figcaption>
        <h4>
            Just look at all that green for each pipeline stage!
        </h4>
    </figcaption>
    
</figure>


<p>With an unbelievable amount of effort, <a href="https://github.com/phanto-m/">phantom</a> has done it again.
Moving the rest of the PICA200 emulation to the GPU was always a sort of &ldquo;white whale&rdquo; for Citra.
We knew it would make things fast, but the sheer amount of effort required to make this happen scared off all those who dared attempt it.
But before we get into why this was so challenging, let&rsquo;s see some real performance numbers!</p>

<h4 id="all-testing-was-done-with-the-following-settings-4x-internal-resolution-accurate-hardware-shaders-on-framelimit-off">All testing was done with the following settings: 4x Internal Resolution, Accurate Hardware Shaders On, Framelimit Off</h4>



<figure style="padding: 20px 0px;">
    
        <img src="/images/entry/improvements-to-hardware-renderer/gpu_vendor_graph.png"  />
    
    
    <figcaption>
        <h4>
            Dedicated GPUs saw the biggest improvement
        </h4>
    </figcaption>
    
</figure>




<figure style="padding: 20px 0px;">
    
        <img src="/images/entry/improvements-to-hardware-renderer/midend_gpu_graph.png"  />
    
    
    <figcaption>
        <h4>
            Mid-High end GPUs tend to be fast
        </h4>
    </figcaption>
    
</figure>




<figure style="padding: 20px 0px;">
    
        <img src="/images/entry/improvements-to-hardware-renderer/lowend_gpu_graph.png"  />
    
    
    <figcaption>
        <h4>
            Low-Mid end GPUs are just a bit fast
        </h4>
    </figcaption>
    
</figure>




<figure style="padding: 20px 0px;">
    
        <img src="/images/entry/improvements-to-hardware-renderer/pokemon_beforeafter_graph.png"  />
    
    
    <figcaption>
        <h4>
            According to telemetry data, Pokémon is the most played game on Citra
        </h4>
    </figcaption>
    
</figure>




<figure style="padding: 20px 0px;">
    
        <img src="/images/entry/improvements-to-hardware-renderer/mh_beforeafter_graph.png"  />
    
    
    <figcaption>
        <h4>
            But Monster Hunter is catching up in playtime
        </h4>
    </figcaption>
    
</figure>


<h2 id="obstacles-to-emulating-the-pica200-on-a-gpu">Obstacles to Emulating the PICA200 on a GPU</h2>

<h3 id="making-functions-out-of-gotos">Making Functions Out of GOTOs</h3>

<p>It&rsquo;s likely that the game developers for the 3DS didn&rsquo;t have to write PICA200 GPU assembly, but when emulating the PICA200, all Citra can work with is a commandlist and a stream of PICA200 opcodes.
While the developers probably wrote in a high level shader language that supports functions, when the shaders are compiled, most of that goes away.
The PICA200 supports barebones <code>CALL</code>, <code>IF</code>, and <code>LOOP</code> operations, but also supports an arbitrary <code>JMP</code> that can go to any address.
Translating PICA200 shaders into GLSL (OpenGL Shader Language) means that you&rsquo;ll have to be prepared to rewrite every arbitrary <code>JMP</code> without using a <code>goto</code> as GLSL doesn&rsquo;t support them.</p>

<p><a href="https://github.com/phanto-m/">phantom</a> assumed the worst when they originally translated PICA200 shaders into GLSL and wrote a monstrous switch statement that would have a case for every jump target and act as a PICA200 shader interpreter.
This worked, but proved to be slower than the software renderer!
Now that <a href="https://github.com/phanto-m/">phantom</a> knew it was possible, and they had some data about how the average PICA200 shader looked, they took to rewrite it with the goal to make it fast.
While the shaders could theoretically be very unruly and hard to convert, almost all the shaders were well behaved, presumably because they are compiled from a higher level language.
This time around, <a href="https://github.com/phanto-m/">phantom</a> generated native GLSL functions wherever possible by analyzing the control flow of the instructions, and the results are much prettier and faster.
Armed with the new knowledge, <a href="https://github.com/phanto-m/">phantom</a> rewrote the conversion a third time, and optimized the generated shaders even further.
What started off slower than the software renderer ended up being the massive performance boost we have today!</p>

<h3 id="multiplication-shouldn-t-be-this-slow">Multiplication Shouldn&rsquo;t Be This Slow</h3>

<p>When converting from PICA200 shaders into GLSL, there are a few PICA200 opcodes that should just match up without any issues.
Addition, subtraction, and multiplication should &hellip; wait. Where did this issue come from?</p>







<div class="container" style="width: 100%;">
    
    <div class="is-img-preview">
    
        
        
        
        <div class="theme-table-image col-sm-6">
            <figure style="padding: 0px;">
                
                    <a href="/images/entry/improvements-to-hardware-renderer/accurate_mul_on.png" title="On: I don&#39;t see any issue...">
                        <img src="/images/entry/improvements-to-hardware-renderer/accurate_mul_on.png" alt="On: I don&#39;t see any issue..." />
                    </a>
                
                <figcaption>
                    <h4>
                        On: I don&rsquo;t see any issue&hellip;
                    </h4>
                </figcaption>
            </figure>
        </div>
    
        
        
        
        <div class="theme-table-image col-sm-6">
            <figure style="padding: 0px;">
                
                    <a href="/images/entry/improvements-to-hardware-renderer/accurate_mul_off.png" title="Off: Oh. Well maybe Eren looks better this way">
                        <img src="/images/entry/improvements-to-hardware-renderer/accurate_mul_off.png" alt="Off: Oh. Well maybe Eren looks better this way" />
                    </a>
                
                <figcaption>
                    <h4>
                        Off: Oh. Well maybe Eren looks better this way
                    </h4>
                </figcaption>
            </figure>
        </div>
    
    </div>
</div>


<p>It turns out that the PICA200 multiplication opcode has a few edge cases that don&rsquo;t impact a large majority of games, and leads to some hilarious results in others.
On the PICA200, <code>infinity * 0 = 0</code> but in OpenGL <code>infinity * 0 = NaN</code> and this can&rsquo;t be configured.
In the generated GLSL shaders, <a href="https://github.com/phanto-m/">phantom</a> emulates this behavior by making a function call instead of a simple multiplication.</p>

<pre><code class="language-glsl">vec4 sanitize_mul(vec4 lhs, vec4 rhs) {
    vec4 product = lhs * rhs;
    return mix(product, mix(mix(vec4(0.0), product, isnan(rhs)), product, isnan(lhs)), isnan(product));
}
</code></pre>

<p>Alas, it&rsquo;s a performance penalty to use a function everywhere instead of regular multiplication.
On weaker GPUs, we noticed the penalty is so severe, we actually made this configurable.
The whole point of a hardware renderer is to be fast, so eating a penalty when only a small handful of games need this level of accuracy would be regrettable.
You can turn off this feature in the settings by deselecting &ldquo;Accurate Hardware Shader&rdquo; and get a noticeable performance boost, but be aware that a few games will break in strange ways!</p>

<h3 id="finding-bugs-and-working-overtime">Finding Bugs and Working Overtime</h3>

<p>We were very excited to launch this feature when <a href="https://github.com/phanto-m/">phantom</a> declared that it was ready; results from user testing were entirely positive, and the performance improvements were unbelievable, but one thing stood in the way.
No one had yet tested to see if it worked on AMD GPUs.
We called for our good friend <a href="https://dolphin-emu.org/blog/authors/JMC47/">JMC47</a> to break out the AMD card he uses for testing Dolphin, and Citra crashed the driver! Oh no!</p>

<p>From <a href="https://dolphin-emu.org/blog/authors/JMC47/">JMC47</a>&rsquo;s time in Dolphin, he&rsquo;s made a few friends here and there, and he found someone willing to investigate.
After a few gruelling weeks, <a href="https://github.com/JonnyH">JonnyH</a> was able to narrow down what the problem is, and luckily it&rsquo;s not a bug in the AMD drivers.
It turns out that it&rsquo;s a bug in the GL specification, or more precisely, the exact issue is ambiguous wording.
<a href="https://www.khronos.org/registry/OpenGL-Refpages/gl4/html/glDrawRangeElementsBaseVertex.xhtml">glDrawRangeElementsBaseVertex</a> states that the indices should be a pointer, but doesn&rsquo;t say whether the pointer should be to CPU memory or GPU memory.
Citra passed a pointer to CPU memory without a second thought, as both Nvidia and Intel drivers seemed fine with it, but AMD drivers are strict.
As a workaround, <a href="https://github.com/phanto-m/">phantom</a> added support for streaming storage buffers, which allows Citra to work with the data on the CPU and sync it with the GPU when it&rsquo;s time to draw.</p>

<p>It&rsquo;s a challenge to support all of the many GPUs out there, and we&rsquo;ve put in so much work to ensure that this new feature will run on as many hardware configurations as possible.
But it&rsquo;s very likely that there will be some GPUs that do not fully support the new hardware renderer, and so we added another option in the Configuration to allow users to turn this feature off entirely.
Simply changing the &ldquo;Shader Emulation&rdquo; from &ldquo;GPU&rdquo; to &ldquo;CPU&rdquo; will revert to using the same old CPU shaders that Citra was using before.</p>



<figure >
    
        <img src="/images/entry/improvements-to-hardware-renderer/renderer_settings.png"  />
    
    
    <figcaption>
        <h4>
            Check out the new Renderer settings in the Graphics tab
        </h4>
    </figcaption>
    
</figure>


<h2 id="what-s-next">What&rsquo;s next</h2>

<p>While today marks a victory for fast emulation, we always have room for improvement.
As explained earlier in the article, getting OpenGL to work consistently across all platforms and GPUs is surprisingly challenging, so be ready for bugs.
This isn&rsquo;t the end for the hardware renderer, but a wonderful boost to one of Citra&rsquo;s more complicated features.
There is always something more that can be done to make the hardware renderer even faster and more accurate (contributions welcome!), but in the meantime, we hope you enjoy playing even more games at full speed!</p>
  </div>

  
  
  

  <div class="entry-written-by">
    
      <a href="https://community.citra-emu.org/users/jroweboy">
          <img src="https://community.citra-emu.org/user_avatar/community.citra-emu.org/jroweboy/120/30_1.png" class="avatar">
      </a>
    
    
    

    
      <p>Written by <a href="https://community.citra-emu.org/users/jroweboy">jroweboy</a> on Saturday March 10, 2018</p>
    
  </div>

  
    <div class="entry-comments">
      <div id="discourse-comments"></div>
      <script type="text/javascript">
        DiscourseEmbed = { discourseUrl: 'https://community.citra-emu.org/', topicId: "11831" };
        (function() {
          var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
          d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
        })();
      </script>
    </div>
  


                </div>
                <div id="sidebar" class="col-xs-12 col-sm-12 col-md-3 col-lg-3 pull-left">
                    <div id="advertisement" class = "ad">
  <h3>Advertisement</h3>
  <ins class="ad adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-4126545610079023"
       data-ad-slot="4223809695"></ins>
  <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>

<div class="tagcloud hidden-sm hidden-xs">
  <h3>News Tag Cloud</h3>
  <ul>
    
      <li><a class="taxonomy-citra-release" href="/tags/citra-release">citra-release</a></li>
    
      <li><a class="taxonomy-feature-update" href="/tags/feature-update">feature-update</a></li>
    
      <li><a class="taxonomy-progress-report" href="/tags/progress-report">progress-report</a></li>
    
  </ul>
</div>

<div id="twitter" class="hidden-sm hidden-xs">
  <a class="twitter-timeline" data-tweet-limit="3" href="https://twitter.com/citraemu?ref_src=twsrc%5Etfw">Tweet Feed</a>
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>

                </div>
            </div>
        </div>

        <div id="footer" class="container">
            <div class="row">

                <div class="col-md-2">
                    <h1>Citra</h1>
                    <a href="/">Blog</a>
                    <a href="/download/">Downloads</a>
                    <a href="/screenshots/">Screenshots</a>
                    <a href="https://www.patreon.com/citraemu">Patreon</a>
                    <a href="/donate/">Donate</a>
                </div>

                <div class="col-md-2">
                    <h1>Documentation</h1>
                    <a href="/help/">Help Documents</a>
                    <a href="/game/">Compatibility</a>
                    <a href="/wiki/home/">Dev Wiki</a>
                    <a href="/wiki/faq/">FAQ</a>
                </div>

                <div class="col-md-2">
                    <h1>Blog</h1>
                    <a href="/">News &amp; Articles</a>
                    <a href="https://citra-emu.org/index.xml">RSS 2.0</a>
                </div>

                <div class="col-md-2">
                    <h1>Social</h1>
                    <a href="https://www.youtube.com/channel/UC_dcdgzuapBtAY4ol3x-90Q">YouTube</a>
                    <a href="https://www.facebook.com/citra.emu">Facebook</a>
                    <a href="https://twitter.com/citraemu">Twitter</a>
                    <a href="https://community.citra-emu.org/">Forums</a>
                    <a href="/discord">Discord</a>
                    <a href="/chat">IRC</a>
                    </ul>
                </div>

                <div class="col-md-2">
                    <h1>Get Involved</h1>
                    <a href="https://github.com/citra-emu/citra">GitHub / Source</a>
                    <a href="https://github.com/citra-emu/citra/issues">Issues</a>
                    <a href="https://github.com/citra-emu/citra/pulls">Pull Requests</a>
                </div>

            </div>
            <div id="footer-bottom">
                <div id="footer-brand"></div>
                <div id="footer-legal">Copyright © 2020 Citra Emulator Project</div>
            </div>
        </div>

        <script src="https://citra-emu.org/js/script.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.10.0/baguetteBox.min.css" type="text/css" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.10.0/baguetteBox.min.js" type="text/javascript"></script>

		<script type="text/javascript">
			window.addEventListener("DOMContentLoaded", function() {
			baguetteBox.run('.is-img-preview');
			});
		</script>

        

        
    </body>

</html>
